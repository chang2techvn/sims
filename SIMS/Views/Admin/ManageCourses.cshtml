@model List<SIMS.Models.Course>
@{
    ViewData["Title"] = "Manage Courses";
}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-book"></i> Courses List</h5>
                <div class="d-flex gap-2 align-items-center">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="courseSearchInput" class="form-control search-input" placeholder="Search courses...">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="coursesTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Course Name</th>
                                <th>Subject</th>
                                <th>Semester</th>
                                <th>Major</th>
                                <th>Lecturer</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Any())
                            {
                                int counter = 1;
                                @foreach (var course in Model)
                                {
                                    <tr data-course-id="@course.CourseId" data-subject-id="@course.SubjectId" data-semester-id="@course.SemesterId" data-major-id="@course.MajorId" data-lecturer-id="@course.LecturerId">
                                        <td>@counter</td>
                                        <td>
                                            <strong>@course.CourseName</strong>
                                            <br><small class="text-muted">@course.Subject.Code</small>
                                        </td>
                                        <td>@course.Subject.Name</td>
                                        <td>@course.Semester.Name @course.Semester.Year</td>
                                        <td>
                                            <span class="badge bg-secondary">@course.Major.Name</span>
                                        </td>
                                        <td>@course.Lecturer.User.Name</td>
                                        <td>
                                            <button class="btn btn-link text-primary p-0 me-2" onclick="editCourse(@course.CourseId, '@course.CourseName', @course.SubjectId, @course.SemesterId, @course.MajorId, @course.LecturerId)" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-link text-info p-0 me-2" onclick="viewCourseStudents(@course.CourseId, '@course.CourseName')" title="View Students">
                                                <i class="fas fa-users"></i>
                                            </button>
                                            <button class="btn btn-link text-danger p-0" onclick="deleteCourse(@course.CourseId, '@course.CourseName')" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    counter++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-book text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-3">No courses found. Create your first course!</p>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> Add New Course</h5>
            </div>
            <div class="card-body">
                <form id="createCourseForm">
                    <div class="form-group">
                        <label class="form-label">Course Name</label>
                        <input name="CourseName" id="createCourseName" class="form-control" placeholder="Enter course name" required />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <select name="SubjectId" id="createSubjectId" class="form-select" required>
                            <option value="">Select Subject</option>
                            @foreach (var subject in ViewBag.Subjects as List<SIMS.Models.Subject>)
                            {
                                <option value="@subject.SubjectId">@subject.Name (@subject.Code)</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Semester</label>
                        <select name="SemesterId" id="createSemesterId" class="form-select" required>
                            <option value="">Select Semester</option>
                            @foreach (var semester in ViewBag.Semesters as List<SIMS.Models.Semester>)
                            {
                                <option value="@semester.SemesterId">@semester.Name @semester.Year</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Major</label>
                        <select name="MajorId" id="createMajorId" class="form-select" required>
                            <option value="">Select Major</option>
                            @foreach (var major in ViewBag.Majors as List<SIMS.Models.Major>)
                            {
                                <option value="@major.MajorId">@major.Name</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Lecturer</label>
                        <select name="LecturerId" id="createLecturerId" class="form-select" required>
                            <option value="">Select Lecturer</option>
                            @foreach (var lecturer in ViewBag.Lecturers as List<SIMS.Models.Lecturer>)
                            {
                                <option value="@lecturer.LecturerId">@lecturer.User.Name</option>
                            }
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus"></i> Add Course
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCourseForm">
                    <input type="hidden" id="editCourseId" />
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Course Name</label>
                        <input type="text" id="editCourseName" class="form-control" required />
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Subject</label>
                        <select id="editSubjectId" class="form-select" required>
                            <option value="">Select Subject</option>
                            @foreach (var subject in ViewBag.Subjects as List<SIMS.Models.Subject>)
                            {
                                <option value="@subject.SubjectId">@subject.Name (@subject.Code)</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Semester</label>
                        <select id="editSemesterId" class="form-select" required>
                            <option value="">Select Semester</option>
                            @foreach (var semester in ViewBag.Semesters as List<SIMS.Models.Semester>)
                            {
                                <option value="@semester.SemesterId">@semester.Name @semester.Year</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Major</label>
                        <select id="editMajorId" class="form-select" required>
                            <option value="">Select Major</option>
                            @foreach (var major in ViewBag.Majors as List<SIMS.Models.Major>)
                            {
                                <option value="@major.MajorId">@major.Name</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Lecturer</label>
                        <select id="editLecturerId" class="form-select" required>
                            <option value="">Select Lecturer</option>
                            @foreach (var lecturer in ViewBag.Lecturers as List<SIMS.Models.Lecturer>)
                            {
                                <option value="@lecturer.LecturerId">@lecturer.User!.Name</option>
                            }
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCourse()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Course Modal -->
<div class="modal fade" id="deleteCourseModal" tabindex="-1" aria-labelledby="deleteCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCourseModalLabel"><i class="fas fa-trash"></i> Delete Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the course "<strong id="deleteCourseName"></strong>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCourse()">
                    <i class="fas fa-trash"></i> Delete Course
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Course Students Modal -->
<div class="modal fade" id="viewStudentsModal" tabindex="-1" aria-labelledby="viewStudentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewStudentsModalLabel"><i class="fas fa-users"></i> Course Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="courseInfo" class="mb-3">
                    <h6 id="courseTitle"></h6>
                    <small class="text-muted" id="courseDetails"></small>
                </div>
                <div id="studentsList">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Create Course
    $('#createCourseForm').on('submit', function(e) {
        e.preventDefault();
        
        var formData = {
            CourseName: $('#createCourseName').val(),
            SubjectId: $('#createSubjectId').val(),
            SemesterId: $('#createSemesterId').val(),
            MajorId: $('#createMajorId').val(),
            LecturerId: $('#createLecturerId').val()
        };
        
        var formDataObj = new FormData();
        formDataObj.append('CourseName', formData.CourseName);
        formDataObj.append('SubjectId', formData.SubjectId);
        formDataObj.append('SemesterId', formData.SemesterId);
        formDataObj.append('MajorId', formData.MajorId);
        formDataObj.append('LecturerId', formData.LecturerId);
        
        $.ajax({
            url: '@Url.Action("CreateCourse", "Admin")',
            type: 'POST',
            data: formDataObj,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    
                    var course = response.course;
                    var courseNameEscaped = (course.courseName || '').replace(/'/g, "\\'");
                    
                    // Calculate next counter
                    var currentRows = $('#coursesTable tbody tr').length;
                    var nextCounter = currentRows + 1;
                    
                    // Add new row to table
                    var newRow = `
                        <tr data-course-id="${course.courseId}" data-subject-id="${course.subjectId}" data-semester-id="${course.semesterId}" data-major-id="${course.majorId}" data-lecturer-id="${course.lecturerId}">
                            <td>${nextCounter}</td>
                            <td>
                                <strong>${course.courseName || 'N/A'}</strong>
                                <br><small class="text-muted">${course.subjectCode || 'N/A'}</small>
                            </td>
                            <td>${course.subjectName || 'N/A'}</td>
                            <td>${course.semesterName || 'N/A'} ${course.semesterYear || ''}</td>
                            <td><span class="badge bg-secondary">${course.majorName || 'N/A'}</span></td>
                            <td>${course.lecturerName || 'N/A'}</td>
                            <td>
                                <button class="btn btn-link text-primary p-0 me-2" onclick="editCourse(${course.courseId}, '${courseNameEscaped}', ${$('#createSubjectId').val()}, ${$('#createSemesterId').val()}, ${$('#createMajorId').val()}, ${$('#createLecturerId').val()})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="@Url.Action("CourseStudents", "Admin")?id=${course.courseId}" class="btn btn-link text-info p-0 me-2" title="View Students">
                                    <i class="fas fa-users"></i>
                                </a>
                                <button class="btn btn-link text-danger p-0" onclick="deleteCourse(${course.courseId}, '${courseNameEscaped}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    
                    // Check if table has "no courses" message or empty
                    var emptyMessage = $('#coursesTable tbody tr td[colspan]');
                    if (emptyMessage.length > 0) {
                        $('#coursesTable tbody').html(newRow);
                    } else {
                        $('#coursesTable tbody').append(newRow);
                    }
                    
                    // Reset form
                    $('#createCourseForm')[0].reset();
                } else {
                    showToast(response.message || 'Failed to create course', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('Create course error:', error, xhr.responseText);
                showToast('Failed to create course', 'danger');
            }
        });
    });
    
    // Edit Course
    function editCourse(id, name, subjectId, semesterId, majorId, lecturerId) {
        $('#editCourseId').val(id);
        $('#editCourseName').val(name);
        $('#editSubjectId').val(subjectId);
        $('#editSemesterId').val(semesterId);
        $('#editMajorId').val(majorId);
        $('#editLecturerId').val(lecturerId);
        
        $('#editCourseModal').modal('show');
    }
    
    // Update Course
    function updateCourse() {
        var formData = {
            CourseId: $('#editCourseId').val(),
            CourseName: $('#editCourseName').val(),
            SubjectId: $('#editSubjectId').val(),
            SemesterId: $('#editSemesterId').val(),
            MajorId: $('#editMajorId').val(),
            LecturerId: $('#editLecturerId').val()
        };
        
        var formDataObj = new FormData();
        formDataObj.append('CourseId', formData.CourseId);
        formDataObj.append('CourseName', formData.CourseName);
        formDataObj.append('SubjectId', formData.SubjectId);
        formDataObj.append('SemesterId', formData.SemesterId);
        formDataObj.append('MajorId', formData.MajorId);
        formDataObj.append('LecturerId', formData.LecturerId);
        
        $.ajax({
            url: '@Url.Action("UpdateCourse", "Admin")',
            type: 'POST',
            data: formDataObj,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    
                    var course = response.course;
                    var courseNameEscaped = (course.courseName || '').replace(/'/g, "\\'");
                    
                    // Update row in table
                    var row = $(`tr[data-course-id="${formData.CourseId}"]`);
                    row.html(`
                        <td>
                            <strong>${course.courseName || 'N/A'}</strong>
                            <br><small class="text-muted">${course.subjectCode || 'N/A'}</small>
                        </td>
                        <td>${course.subjectName || 'N/A'}</td>
                        <td>${course.semesterName || 'N/A'} ${course.semesterYear || ''}</td>
                        <td><span class="badge bg-secondary">${course.majorName || 'N/A'}</span></td>
                        <td>${course.lecturerName || 'N/A'}</td>
                        <td>
                            <button class="btn btn-link text-primary p-0 me-2" onclick="editCourse(${course.courseId}, '${courseNameEscaped}', ${formData.SubjectId}, ${formData.SemesterId}, ${formData.MajorId}, ${formData.LecturerId})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="@Url.Action("CourseStudents", "Admin")?id=${course.courseId}" class="btn btn-link text-info p-0 me-2" title="View Students">
                                <i class="fas fa-users"></i>
                            </a>
                            <button class="btn btn-link text-danger p-0" onclick="deleteCourse(${course.courseId}, '${courseNameEscaped}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `);
                    
                    $('#editCourseModal').modal('hide');
                } else {
                    showToast(response.message || 'Failed to update course', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('Update course error:', error, xhr.responseText);
                showToast('Failed to update course', 'danger');
            }
        });
    }
    
    // Delete Course
    let deleteCourseId = null;
    let deleteCourseName = null;

    function deleteCourse(id, name) {
        deleteCourseId = id;
        deleteCourseName = name;
        document.getElementById('deleteCourseName').textContent = name;
        $('#deleteCourseModal').modal('show');
    }

    function confirmDeleteCourse() {
        if (!deleteCourseId) return;

        $.ajax({
            url: '@Url.Action("DeleteCourse", "Admin")',
            type: 'POST',
            data: { id: deleteCourseId },
            success: function(response) {
                if (response.success) {
                    $('#deleteCourseModal').modal('hide');
                    showToast(response.message, 'success');
                    
                    // Remove row from table
                    $(`tr[data-course-id="${deleteCourseId}"]`).fadeOut(300, function() {
                        $(this).remove();
                        
                        // Check if table is empty
                        if ($('#coursesTable tbody tr:visible').length === 0) {
                            $('#coursesTable tbody').html(`
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-book text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-3">No courses found. Create your first course!</p>
                                    </td>
                                </tr>
                            `);
                        }
                    });
                } else {
                    showToast(response.message || 'Failed to delete course', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('Delete course error:', error, xhr.responseText);
                showToast('Failed to delete course', 'danger');
            }
        });
    }

    function viewCourseStudents(courseId, courseName) {
        // Set modal title
        document.getElementById('viewStudentsModalLabel').innerHTML = '<i class="fas fa-users"></i> Students in ' + courseName;
        
        // Show loading
        document.getElementById('studentsList').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        // Show modal
        new bootstrap.Modal(document.getElementById('viewStudentsModal')).show();
        
        // Fetch students data
        fetch('@Url.Action("GetCourseStudents", "Admin")/?courseId=' + courseId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update course info
                    document.getElementById('courseTitle').textContent = data.courseName;
                    document.getElementById('courseDetails').textContent = data.subjectName + ' - ' + data.semesterName;
                    
                    // Update students list
                    let studentsHtml = '';
                    if (data.students && data.students.length > 0) {
                        studentsHtml = `
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Avatar</th>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.students.forEach(student => {
                            const avatarUrl = student.avatar ? '/uploads/avatars/' + student.avatar : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPHBhdGggZD0iTTIwIDIwQzIyLjc2MTQgMjAgMjUgMTcuNzYxNCAyNSAyMEMyOCAyMi4yMzggMjYuMjM4IDI1IDI1IDI1SDE1QzEzLjc2MTQgMjUgMTIgMjIuMjM4IDEyIDIwQzEyIDE3Ljc2MTQgMTMuNzYxNCAyMCAxMy43NjE0IDIwWiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4=';
                            studentsHtml += `
                                <tr>
                                    <td>
                                        <img src="${avatarUrl}" alt="Avatar" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPHBhdGggZD0iTTIwIDIwQzIyLjc2MTQgMjAgMjUgMTcuNzYxNCAyNSAyMEMyOCAyMi4yMzggMjYuMjM4IDI1IDI1IDI1SDE1QzEzLjc2MTQgMjUgMTIgMjIuMjM4IDEyIDIwQzEyIDE3Ljc2MTQgMTMuNzYxNCAyMCAxMy43NjE0IDIwWiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4=';">
                                    </td>
                                    <td>${student.studentId}</td>
                                    <td>${student.name}</td>
                                    <td>${student.email}</td>
                                </tr>
                            `;
                        });
                        
                        studentsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        studentsHtml = `
                            <div class="text-center py-4">
                                <i class="fas fa-user-slash text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3">No students enrolled in this course.</p>
                            </div>
                        `;
                    }
                    
                    document.getElementById('studentsList').innerHTML = studentsHtml;
                } else {
                    document.getElementById('studentsList').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('studentsList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load students data.
                    </div>
                `;
            });
    }

    // Search Courses Function
    $('#courseSearchInput').on('keyup', function() {
        applyFilters();
    });

    // Filter Courses Function
    let currentFilter = { type: 'all', value: null };

    function filterCourses(filterType, filterValue = null) {
        currentFilter = { type: filterType, value: filterValue };
        
        // Update dropdown button text
        const button = $('#filterDropdown');
        if (filterType === 'all') {
            button.html('<i class="fas fa-filter"></i> Filter');
        } else {
            let filterText = '';
            switch(filterType) {
                case 'subject': filterText = 'Subject'; break;
                case 'semester': filterText = 'Semester'; break;
                case 'major': filterText = 'Major'; break;
                case 'lecturer': filterText = 'Lecturer'; break;
            }
            button.html('<i class="fas fa-filter"></i> ' + filterText);
        }
        
        applyFilters();
    }

    function applyFilters() {
        const searchValue = $('#courseSearchInput').val().toLowerCase();
        
        $('#coursesTable tbody tr').each(function() {
            const row = $(this);
            
            // Skip the no results message row
            if (row.attr('id') === 'noResultsMessage') return;
            
            const rowText = row.text().toLowerCase();
            let showRow = true;
            
            // Apply search filter
            if (searchValue !== '' && !rowText.includes(searchValue)) {
                showRow = false;
            }
            
            // Apply category filter
            if (showRow && currentFilter.type !== 'all') {
                const dataAttr = 'data-' + currentFilter.type + '-id';
                const rowValue = row.attr(dataAttr);
                if (rowValue !== currentFilter.value) {
                    showRow = false;
                }
            }
            
            if (showRow) {
                row.show();
            } else {
                row.hide();
            }
        });
        
        // Show message if no results
        const visibleRows = $('#coursesTable tbody tr:visible').not('#noResultsMessage').length;
        if (visibleRows === 0) {
            if ($('#noResultsMessage').length === 0) {
                $('#coursesTable tbody').append(
                    '<tr id="noResultsMessage"><td colspan="7" class="text-center text-muted py-4">' +
                    '<i class="fas fa-search" style="font-size: 2rem;"></i>' +
                    '<p class="mt-2">No courses found matching your criteria.</p>' +
                    '</td></tr>'
                );
            }
        } else {
            $('#noResultsMessage').remove();
        }
    }
</script>
}
